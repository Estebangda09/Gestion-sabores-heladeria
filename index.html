<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - Helader√≠a</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: #f5f5f5;
            border: none;
            font-size: 1.1em;
            transition: all 0.3s;
        }

        .tab:hover {
            background: #e0e0e0;
        }

        .tab.active {
            background: white;
            border-bottom: 3px solid #667eea;
            font-weight: bold;
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: transform 0.2s;
            margin-right: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #c92a2a 100%);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }

        .card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .card p {
            margin: 8px 0;
            color: #666;
        }

        .card-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .card-actions button {
            flex: 1;
            padding: 8px;
            font-size: 0.9em;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .flavor-category {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 20px;
            display: inline-block;
            margin: 5px;
            font-size: 0.9em;
        }

        .screen-url {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #667eea;
        }

        .screen-url code {
            background: #e9ecef;
            padding: 5px 10px;
            border-radius: 4px;
            font-family: monospace;
            display: block;
            margin-top: 10px;
            word-break: break-all;
        }

        .price-list {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .price-list h4 {
            margin-bottom: 10px;
            color: #667eea;
        }

        .price-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ddd;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.2em;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üç¶ Panel de Administraci√≥n</h1>
            <p>Gesti√≥n de Sabores y Sucursales</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('sucursales')">Sucursales</button>
            <button class="tab" onclick="showTab('sabores')">Sabores</button>
            <button class="tab" onclick="showTab('precios')">Precios</button>
            <button class="tab" onclick="showTab('config')">Configuraci√≥n</button>
        </div>

        <div class="content">
            <div id="success-msg" class="success-message"></div>
            <div id="error-msg" class="error-message"></div>

            <!-- TAB: Sucursales -->
            <div id="sucursales-tab" class="tab-content active">
                <h2>Gesti√≥n de Sucursales</h2>
                
                <form id="branch-form" onsubmit="saveBranch(event)">
                    <div class="form-group">
                        <label>Nombre de la Sucursal</label>
                        <input type="text" id="branch-name" required placeholder="Ej: Centro, Norte, Sur">
                    </div>
                    
                    <div class="form-group">
                        <label>Ubicaci√≥n</label>
                        <input type="text" id="branch-location" required placeholder="Direcci√≥n completa">
                    </div>
                    
                    <div class="form-group">
                        <label>ID √önico (para URL)</label>
                        <input type="text" id="branch-id" required placeholder="centro, norte, sur" pattern="[a-z0-9-]+" title="Solo letras min√∫sculas, n√∫meros y guiones">
                    </div>
                    
                    <button type="submit" class="btn">Crear Sucursal</button>
                </form>

                <div id="branches-list" class="grid"></div>
            </div>

            <!-- TAB: Sabores -->
            <div id="sabores-tab" class="tab-content">
                <h2>Gesti√≥n de Sabores</h2>
                
                <form id="flavor-form" onsubmit="saveFlavor(event)">
                    <div class="form-group">
                        <label>Sucursal</label>
                        <select id="flavor-branch" required>
                            <option value="">Seleccionar sucursal...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Categor√≠a</label>
                        <select id="flavor-category" required>
                            <option value="cremas">Cremas para deleitarse</option>
                            <option value="chocolates">Chocolates para ser feliz</option>
                            <option value="dulces">Dulces placeres</option>
                            <option value="frutas">Frutas de estaci√≥n</option>
                            <option value="recomendados">Recomendados</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Nombre del Sabor</label>
                        <input type="text" id="flavor-name" required placeholder="Ej: Frutilla a la crema">
                    </div>
                    
                    <div class="form-group">
                        <label>Disponible</label>
                        <select id="flavor-available" required>
                            <option value="true">S√≠</option>
                            <option value="false">No</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn">Agregar Sabor</button>
                </form>

                <div id="flavors-list" class="grid"></div>
            </div>

            <!-- TAB: Precios -->
            <div id="precios-tab" class="tab-content">
                <h2>Gesti√≥n de Precios</h2>
                
                <form id="prices-form" onsubmit="savePrices(event)">
                    <div class="form-group">
                        <label>Sucursal</label>
                        <select id="prices-branch" required>
                            <option value="">Seleccionar sucursal...</option>
                        </select>
                    </div>

                    <h3>Precios por Tama√±o</h3>
                    
                    <div class="form-group">
                        <label>1 KILO</label>
                        <input type="number" id="price-1kg" required placeholder="20500">
                    </div>
                    
                    <div class="form-group">
                        <label>1/2 KILO</label>
                        <input type="number" id="price-half-kg" required placeholder="12500">
                    </div>
                    
                    <div class="form-group">
                        <label>1/4 KILO</label>
                        <input type="number" id="price-quarter-kg" required placeholder="6700">
                    </div>
                    
                    <div class="form-group">
                        <label>CUCURUCHO 210g</label>
                        <input type="number" id="price-cucurucho" required placeholder="6500">
                    </div>
                    
                    <div class="form-group">
                        <label>VASO MEDIANO 120g</label>
                        <input type="number" id="price-vaso" required placeholder="5000">
                    </div>
                    
                    <div class="form-group">
                        <label>TACITA MEDIANA 200g</label>
                        <input type="number" id="price-tacita-med" required placeholder="6000">
                    </div>
                    
                    <div class="form-group">
                        <label>TACITA CHICA 60g (sin saber)</label>
                        <input type="number" id="price-tacita-chica" required placeholder="2800">
                    </div>
                    
                    <div class="form-group">
                        <label>MILK SHAKE 200g</label>
                        <input type="number" id="price-milkshake" required placeholder="7000">
                    </div>
                    
                    <div class="form-group">
                        <label>COOL SHAKE 200g</label>
                        <input type="number" id="price-coolshake" required placeholder="7000">
                    </div>
                    
                    <button type="submit" class="btn">Guardar Precios</button>
                </form>
            </div>

            <!-- TAB: Configuraci√≥n -->
            <div id="config-tab" class="tab-content">
                <h2>Configuraci√≥n del Sistema</h2>
                
                <div class="form-group">
                    <label>URL de Google Sheets (Script Web App)</label>
                    <input type="text" id="sheets-url" placeholder="https://script.google.com/macros/s/...">
                    <small>Ingresa la URL del script web que configuraste en Google Sheets</small>
                </div>
                
                <button onclick="saveConfig()" class="btn">Guardar Configuraci√≥n</button>
                <button onclick="testConnection()" class="btn btn-secondary">Probar Conexi√≥n</button>
                
                <div id="connection-status" style="margin-top: 20px; padding: 15px; border-radius: 8px; display: none;"></div>

                <div class="screen-url" style="margin-top: 30px;">
                    <h3>üìù Instrucciones de Configuraci√≥n</h3>
                    <ol style="line-height: 2; color: #333;">
                        <li>Crea una hoja de c√°lculo en Google Sheets</li>
                        <li>Ve a <strong>Extensiones > Apps Script</strong></li>
                        <li>Copia el c√≥digo del archivo <code>google-apps-script.js</code></li>
                        <li>Haz clic en <strong>Implementar > Nueva implementaci√≥n</strong></li>
                        <li>Selecciona tipo: <strong>Aplicaci√≥n web</strong></li>
                        <li>Configurar:
                            <ul>
                                <li>Ejecutar como: <strong>Tu cuenta</strong></li>
                                <li>Qui√©n tiene acceso: <strong>Cualquiera</strong></li>
                            </ul>
                        </li>
                        <li>Copia la URL generada y p√©gala arriba</li>
                        <li>Haz clic en <strong>Probar Conexi√≥n</strong></li>
                    </ol>
                </div>

                <div class="screen-url" style="margin-top: 20px;">
                    <h3>üì∫ URLs de Pantallas por Sucursal</h3>
                    <p>Cada sucursal tendr√° su propia URL para mostrar en pantalla:</p>
                    <code id="screen-urls">Primero crea las sucursales</code>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n
        let SHEETS_URL = localStorage.getItem('sheetsUrl') || '';
        let branches = [];
        let flavors = [];
        let prices = {};

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            loadConfig();
            loadData();
        });

        // Gesti√≥n de tabs
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        // Cargar configuraci√≥n
        function loadConfig() {
            const url = localStorage.getItem('sheetsUrl');
            if (url) {
                document.getElementById('sheets-url').value = url;
                SHEETS_URL = url;
            }
        }

        // Guardar configuraci√≥n
        function saveConfig() {
            const url = document.getElementById('sheets-url').value;
            if (!url) {
                showError('Por favor ingresa una URL v√°lida');
                return;
            }
            localStorage.setItem('sheetsUrl', url);
            SHEETS_URL = url;
            showSuccess('Configuraci√≥n guardada correctamente');
        }

        // Probar conexi√≥n
        async function testConnection() {
            const url = document.getElementById('sheets-url').value;
            if (!url) {
                showError('Por favor ingresa una URL primero');
                return;
            }

            const statusDiv = document.getElementById('connection-status');
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#fff3cd';
            statusDiv.style.color = '#856404';
            statusDiv.innerHTML = '‚è≥ Probando conexi√≥n con Google Sheets...';

            try {
                console.log('Probando conexi√≥n a:', url);
                const response = await fetch(`${url}?action=getData`);
                
                console.log('Response status:', response.status);
                console.log('Response OK:', response.ok);
                
                const text = await response.text();
                console.log('Response text:', text);
                
                const data = JSON.parse(text);
                console.log('Parsed data:', data);

                if (data.success) {
                    statusDiv.style.background = '#d4edda';
                    statusDiv.style.color = '#155724';
                    statusDiv.innerHTML = `
                        ‚úÖ <strong>Conexi√≥n exitosa!</strong><br>
                        Sucursales: ${data.data.branches?.length || 0}<br>
                        Sabores: ${data.data.flavors?.length || 0}<br>
                        Precios configurados: ${Object.keys(data.data.prices || {}).length}
                    `;
                    
                    // Guardar autom√°ticamente si la conexi√≥n es exitosa
                    localStorage.setItem('sheetsUrl', url);
                    SHEETS_URL = url;
                    
                    // Cargar datos
                    loadData();
                } else {
                    throw new Error(data.message || 'Error desconocido del servidor');
                }
            } catch (error) {
                console.error('Error en test de conexi√≥n:', error);
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.innerHTML = `
                    ‚ùå <strong>Error de conexi√≥n</strong><br>
                    ${error.message}<br><br>
                    <small>Verifica que:
                    <ul style="text-align: left; margin-top: 10px;">
                        <li>La URL sea correcta</li>
                        <li>El script est√© implementado como "Aplicaci√≥n web"</li>
                        <li>El acceso est√© configurado como "Cualquiera"</li>
                        <li>Hayas autorizado los permisos de Google</li>
                    </ul>
                    </small>
                `;
            }
        }

        // Cargar datos
        async function loadData() {
            if (!SHEETS_URL) {
                console.log('No hay URL configurada');
                showError('Primero configura la URL de Google Sheets en la pesta√±a Configuraci√≥n');
                return;
            }

            try {
                console.log('Cargando datos desde:', SHEETS_URL);
                const response = await fetch(`${SHEETS_URL}?action=getData`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Datos recibidos:', data);
                
                if (data.success) {
                    branches = data.data.branches || [];
                    flavors = data.data.flavors || [];
                    prices = data.data.prices || {};
                    
                    console.log('Sucursales cargadas:', branches);
                    console.log('Sabores cargados:', flavors);
                    console.log('Precios cargados:', prices);
                    
                    updateBranchesUI();
                    updateFlavorsUI();
                    updateBranchSelects();
                    updateScreenUrls();
                    
                    showSuccess(`Datos cargados: ${branches.length} sucursales, ${flavors.length} sabores`);
                } else {
                    throw new Error(data.message || 'Error desconocido');
                }
            } catch (error) {
                console.error('Error cargando datos:', error);
                showError('Error al cargar datos: ' + error.message + '. Verifica la configuraci√≥n.');
            }
        }

        // Guardar sucursal
        async function saveBranch(e) {
            e.preventDefault();
            
            const branch = {
                id: document.getElementById('branch-id').value,
                name: document.getElementById('branch-name').value,
                location: document.getElementById('branch-location').value,
                createdAt: new Date().toISOString()
            };

            if (!SHEETS_URL) {
                showError('Configura la URL de Google Sheets primero');
                showTab('config');
                return;
            }

            try {
                const response = await fetch(SHEETS_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'saveBranch',
                        data: branch
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showSuccess('Sucursal creada correctamente');
                    document.getElementById('branch-form').reset();
                    loadData();
                } else {
                    showError('Error al guardar: ' + result.message);
                }
            } catch (error) {
                showError('Error de conexi√≥n: ' + error.message);
            }
        }

        // Guardar sabor
        async function saveFlavor(e) {
            e.preventDefault();
            
            const flavor = {
                branchId: document.getElementById('flavor-branch').value,
                category: document.getElementById('flavor-category').value,
                name: document.getElementById('flavor-name').value,
                available: document.getElementById('flavor-available').value === 'true',
                createdAt: new Date().toISOString()
            };

            if (!SHEETS_URL) {
                showError('Configura la URL de Google Sheets primero');
                return;
            }

            try {
                const response = await fetch(SHEETS_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'saveFlavor',
                        data: flavor
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showSuccess('Sabor agregado correctamente');
                    document.getElementById('flavor-form').reset();
                    loadData();
                } else {
                    showError('Error al guardar: ' + result.message);
                }
            } catch (error) {
                showError('Error de conexi√≥n: ' + error.message);
            }
        }

        // Guardar precios
        async function savePrices(e) {
            e.preventDefault();
            
            const priceData = {
                branchId: document.getElementById('prices-branch').value,
                prices: {
                    '1kg': parseInt(document.getElementById('price-1kg').value),
                    'halfKg': parseInt(document.getElementById('price-half-kg').value),
                    'quarterKg': parseInt(document.getElementById('price-quarter-kg').value),
                    'cucurucho': parseInt(document.getElementById('price-cucurucho').value),
                    'vaso': parseInt(document.getElementById('price-vaso').value),
                    'tacitaMed': parseInt(document.getElementById('price-tacita-med').value),
                    'tacitaChica': parseInt(document.getElementById('price-tacita-chica').value),
                    'milkshake': parseInt(document.getElementById('price-milkshake').value),
                    'coolshake': parseInt(document.getElementById('price-coolshake').value)
                },
                updatedAt: new Date().toISOString()
            };

            if (!SHEETS_URL) {
                showError('Configura la URL de Google Sheets primero');
                return;
            }

            try {
                const response = await fetch(SHEETS_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'savePrices',
                        data: priceData
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showSuccess('Precios guardados correctamente');
                    loadData();
                } else {
                    showError('Error al guardar: ' + result.message);
                }
            } catch (error) {
                showError('Error de conexi√≥n: ' + error.message);
            }
        }

        // Actualizar UI de sucursales
        function updateBranchesUI() {
            const container = document.getElementById('branches-list');
            container.innerHTML = '';
            
            branches.forEach(branch => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <h3>${branch.name}</h3>
                    <p><strong>ID:</strong> ${branch.id}</p>
                    <p><strong>Ubicaci√≥n:</strong> ${branch.location}</p>
                    <div class="screen-url">
                        <strong>URL de pantalla:</strong>
                        <code>display.html?branch=${branch.id}</code>
                    </div>
                    <div class="card-actions">
                        <button class="btn btn-danger" onclick="deleteBranch('${branch.id}')">Eliminar</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Actualizar UI de sabores
        function updateFlavorsUI() {
            const container = document.getElementById('flavors-list');
            container.innerHTML = '';
            
            // Agrupar por sucursal
            const flavorsByBranch = {};
            flavors.forEach(flavor => {
                if (!flavorsByBranch[flavor.branchId]) {
                    flavorsByBranch[flavor.branchId] = [];
                }
                flavorsByBranch[flavor.branchId].push(flavor);
            });

            Object.keys(flavorsByBranch).forEach(branchId => {
                const branch = branches.find(b => b.id === branchId);
                const branchFlavors = flavorsByBranch[branchId];
                
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <h3>${branch ? branch.name : branchId}</h3>
                    <p><strong>Total de sabores:</strong> ${branchFlavors.length}</p>
                    ${branchFlavors.map(f => `
                        <div class="flavor-category" style="background: ${f.available ? '#d4edda' : '#f8d7da'}">
                            ${f.name} - ${getCategoryName(f.category)}
                        </div>
                    `).join('')}
                `;
                container.appendChild(card);
            });
        }

        // Actualizar selects de sucursales
        function updateBranchSelects() {
            const selects = ['flavor-branch', 'prices-branch'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">Seleccionar sucursal...</option>';
                
                branches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch.id;
                    option.textContent = branch.name;
                    select.appendChild(option);
                });
            });
        }

        // Actualizar URLs de pantallas
        function updateScreenUrls() {
            const container = document.getElementById('screen-urls');
            const baseUrl = window.location.origin + window.location.pathname.replace('index.html', 'display.html').replace('admin.html', 'display.html');
            
            if (branches.length === 0) {
                container.textContent = 'Primero crea las sucursales en la pesta√±a "Sucursales"';
                container.style.fontSize = '1em';
                container.style.color = '#666';
                return;
            }

            container.innerHTML = branches.map(branch => 
                `<div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                    <strong style="color: #667eea;">${branch.name}:</strong><br>
                    <span style="font-size: 0.9em; color: #666;">${baseUrl}?branch=${branch.id}</span>
                </div>`
            ).join('');
        }

        // Eliminar sucursal
        async function deleteBranch(branchId) {
            if (!confirm('¬øEst√°s seguro de eliminar esta sucursal?')) return;

            try {
                const response = await fetch(SHEETS_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'deleteBranch',
                        branchId: branchId
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showSuccess('Sucursal eliminada');
                    loadData();
                }
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

        // Utilidades
        function getCategoryName(category) {
            const categories = {
                'cremas': 'Cremas',
                'chocolates': 'Chocolates',
                'dulces': 'Dulces',
                'frutas': 'Frutas',
                'recomendados': 'Recomendados'
            };
            return categories[category] || category;
        }

        function showSuccess(message) {
            const msg = document.getElementById('success-msg');
            msg.textContent = message;
            msg.style.display = 'block';
            setTimeout(() => msg.style.display = 'none', 5000);
        }

        function showError(message) {
            const msg = document.getElementById('error-msg');
            msg.textContent = message;
            msg.style.display = 'block';
            setTimeout(() => msg.style.display = 'none', 5000);
        }
    </script>
</body>
</html>
