<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administrativo - Sistema de Men√∫s v2.0</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 250px;
            height: 100vh;
            background: #2d3748;
            color: white;
            padding: 20px;
            overflow-y: auto;
            z-index: 100;
        }

        .logo {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #4a5568;
            text-align: center;
        }

        .menu-item {
            padding: 12px 15px;
            margin: 5px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .menu-item:hover {
            background: #4a5568;
        }

        .menu-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .main-content {
            margin-left: 250px;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .content-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .content-card.active {
            display: block;
        }

        .page-title {
            font-size: 2em;
            color: #2d3748;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-warning {
            background: #ed8936;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85em;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #4a5568;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1em;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        th {
            background: #f7fafc;
            font-weight: 600;
            color: #2d3748;
        }

        tr:hover {
            background: #f7fafc;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge-success {
            background: #c6f6d5;
            color: #22543d;
        }

        .badge-danger {
            background: #fed7d7;
            color: #742a2a;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-success {
            background: #c6f6d5;
            color: #22543d;
            border-left: 4px solid #48bb78;
        }

        .alert-error {
            background: #fed7d7;
            color: #742a2a;
            border-left: 4px solid #f56565;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5em;
            color: #2d3748;
        }

        .close-btn {
            font-size: 1.5em;
            cursor: pointer;
            color: #718096;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
        }

        .checkbox-item:has(input:checked) {
            background: #ebf4ff;
            border-color: #667eea;
        }

        .screen-config {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .screen-config h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab:hover {
            background: #f7fafc;
        }

        .tab.active {
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .visibility-grid {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .visibility-category {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
        }

        .visibility-category h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .sabor-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #e2e8f0;
        }

        .sabor-toggle:last-child {
            border-bottom: none;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: #48bb78;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .price-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .filter-bar {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .filter-bar .form-group {
            margin: 0;
            min-width: 200px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .connection-status {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .connection-status.success {
            background: #c6f6d5;
            color: #22543d;
        }

        .connection-status.error {
            background: #fed7d7;
            color: #742a2a;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            
            .main-content {
                margin-left: 0;
            }

            .form-grid, .price-form {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">üç¶ Sistema Men√∫s</div>
        <div class="menu-item active" onclick="showPage('dashboard')">üìä Dashboard</div>
        <div class="menu-item" onclick="showPage('categorias')">üìÅ Categor√≠as</div>
        <div class="menu-item" onclick="showPage('sabores')">üç® Sabores</div>
        <div class="menu-item" onclick="showPage('sucursales')">üè™ Sucursales</div>
        <div class="menu-item" onclick="showPage('pantallas')">üì∫ Pantallas</div>
        <div class="menu-item" onclick="showPage('precios')">üí∞ Precios</div>
        <div class="menu-item" onclick="showPage('visibilidad')">üëÅÔ∏è Visibilidad</div>
        <div class="menu-item" onclick="showPage('usuarios')">üë• Usuarios</div>
        <div class="menu-item" onclick="showPage('configuracion')">‚öôÔ∏è Configuraci√≥n</div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
            <div>
                <h2>Panel Administrativo</h2>
                <small id="user-info">Usuario: Admin</small>
            </div>
            <button class="btn btn-danger" onclick="logout()">Cerrar Sesi√≥n</button>
        </div>

        <div id="alert-success" class="alert alert-success"></div>
        <div id="alert-error" class="alert alert-error"></div>

        <!-- Dashboard -->
        <div id="page-dashboard" class="content-card active">
            <h1 class="page-title">Dashboard</h1>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="stat-categorias">0</div>
                    <div class="stat-label">Categor√≠as</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-sabores">0</div>
                    <div class="stat-label">Sabores</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-sucursales">0</div>
                    <div class="stat-label">Sucursales</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-pantallas">0</div>
                    <div class="stat-label">Pantallas</div>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="syncData()">üîÑ Sincronizar con Google Sheets</button>
            <button class="btn btn-success" onclick="loadFromSheets()" style="margin-left: 10px;">üì• Cargar Datos</button>
        </div>

        <!-- Categor√≠as -->
        <div id="page-categorias" class="content-card">
            <h1 class="page-title">Gesti√≥n de Categor√≠as</h1>
            
            <button class="btn btn-primary" onclick="openModalCategoria()">+ Nueva Categor√≠a</button>
            
            <div class="table-container">
                <table id="table-categorias">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Descripci√≥n</th>
                            <th>Orden</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Sabores -->
        <div id="page-sabores" class="content-card">
            <h1 class="page-title">Gesti√≥n de Sabores</h1>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="openModalSabor()">+ Nuevo Sabor</button>
                <div class="filter-bar">
                    <div class="form-group">
                        <select id="filter-categoria" onchange="filterSabores()">
                            <option value="">Todas las categor√≠as</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <select id="filter-estado" onchange="filterSabores()">
                            <option value="">Todos los estados</option>
                            <option value="activo">Activos</option>
                            <option value="inactivo">Inactivos</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="table-container">
                <table id="table-sabores">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Categor√≠a</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Sucursales -->
        <div id="page-sucursales" class="content-card">
            <h1 class="page-title">Gesti√≥n de Sucursales</h1>
            
            <button class="btn btn-primary" onclick="openModalSucursal()">+ Nueva Sucursal</button>
            
            <div class="table-container">
                <table id="table-sucursales">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Direcci√≥n</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Pantallas -->
        <div id="page-pantallas" class="content-card">
            <h1 class="page-title">Configuraci√≥n de Pantallas</h1>
            
            <button class="btn btn-primary" onclick="openModalPantalla()">+ Nueva Pantalla</button>
            
            <div id="pantallas-list"></div>
        </div>

        <!-- Precios -->
        <div id="page-precios" class="content-card">
            <h1 class="page-title">Gesti√≥n de Precios</h1>
            
            <div class="tabs">
                <div class="tab active" onclick="showTabPrecios('global')">Precios Globales</div>
                <div class="tab" onclick="showTabPrecios('sucursal')">Por Sucursal</div>
            </div>

            <div id="precios-global" class="tab-content active">
                <h3>Precios que aplican a todas las sucursales</h3>
                <form onsubmit="savePreciosGlobal(event)">
                    <div class="price-form" id="form-precios-global"></div>
                    <button type="submit" class="btn btn-primary" style="margin-top: 20px;">Guardar Precios Globales</button>
                </form>
            </div>

            <div id="precios-sucursal" class="tab-content">
                <div class="form-group" style="max-width: 300px;">
                    <label>Seleccionar sucursal:</label>
                    <select id="select-sucursal-precios" onchange="loadPreciosSucursal()">
                        <option value="">Seleccionar...</option>
                    </select>
                </div>
                <div id="container-precios-sucursal"></div>
            </div>
        </div>

        <!-- Visibilidad -->
        <div id="page-visibilidad" class="content-card">
            <h1 class="page-title">Control de Visibilidad</h1>
            
            <p style="margin-bottom: 20px;">Controla qu√© sabores est√°n disponibles en cada sucursal</p>
            
            <div class="form-group" style="max-width: 300px;">
                <label>Seleccionar sucursal:</label>
                <select id="select-sucursal-visibilidad" onchange="loadVisibilidad()">
                    <option value="">Seleccionar...</option>
                </select>
            </div>

            <div id="visibilidad-container"></div>
        </div>

        <!-- Usuarios -->
        <div id="page-usuarios" class="content-card">
            <h1 class="page-title">Gesti√≥n de Usuarios</h1>
            
            <button class="btn btn-primary" onclick="openModalUsuario()">+ Nuevo Usuario</button>
            
            <div class="table-container">
                <table id="table-usuarios">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Email</th>
                            <th>Rol</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Configuraci√≥n -->
        <div id="page-configuracion" class="content-card">
            <h1 class="page-title">Configuraci√≥n del Sistema</h1>
            
            <div class="form-group">
                <label>URL de Google Sheets (Web App):</label>
                <input type="text" id="sheets-url" placeholder="https://script.google.com/macros/s/.../exec">
            </div>
            
            <button class="btn btn-primary" onclick="saveConfig()">Guardar Configuraci√≥n</button>
            <button class="btn btn-success" onclick="testConnection()">Probar Conexi√≥n</button>
            
            <div id="connection-status"></div>

            <div style="margin-top: 30px; padding: 20px; background: #f7fafc; border-radius: 8px;">
                <h3>üì∫ URLs de Pantallas</h3>
                <p style="margin: 10px 0;">Cada pantalla tendr√° su URL √∫nica:</p>
                <div id="screen-urls"></div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="modalCategoria" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Categor√≠a</h2>
                <span class="close-btn" onclick="closeModal('modalCategoria')">&times;</span>
            </div>
            <form onsubmit="saveCategoria(event)">
                <input type="hidden" id="categoria-id">
                <div class="form-group">
                    <label>Nombre *</label>
                    <input type="text" id="categoria-nombre" required>
                </div>
                <div class="form-group">
                    <label>Descripci√≥n</label>
                    <input type="text" id="categoria-descripcion">
                </div>
                <div class="form-group">
                    <label>Orden de visualizaci√≥n</label>
                    <input type="number" id="categoria-orden" value="0">
                </div>
                <div class="form-group">
                    <label>Estado</label>
                    <select id="categoria-estado">
                        <option value="activo">Activo</option>
                        <option value="inactivo">Inactivo</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Guardar</button>
            </form>
        </div>
    </div>

    <div id="modalSabor" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Sabor</h2>
                <span class="close-btn" onclick="closeModal('modalSabor')">&times;</span>
            </div>
            <form onsubmit="saveSabor(event)">
                <input type="hidden" id="sabor-id">
                <div class="form-group">
                    <label>Nombre *</label>
                    <input type="text" id="sabor-nombre" required>
                </div>
                <div class="form-group">
                    <label>Categor√≠a *</label>
                    <select id="sabor-categoria" required></select>
                </div>
                <div class="form-group">
                    <label>Descripci√≥n</label>
                    <textarea id="sabor-descripcion" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Estado</label>
                    <select id="sabor-estado">
                        <option value="activo">Activo</option>
                        <option value="inactivo">Inactivo</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Guardar</button>
            </form>
        </div>
    </div>

    <div id="modalSucursal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Sucursal</h2>
                <span class="close-btn" onclick="closeModal('modalSucursal')">&times;</span>
            </div>
            <form onsubmit="saveSucursal(event)">
                <input type="hidden" id="sucursal-id">
                <div class="form-group">
                    <label>ID √önico * (para URLs, sin espacios)</label>
                    <input type="text" id="sucursal-id-text" pattern="[a-z0-9-]+" required placeholder="centro">
                </div>
                <div class="form-group">
                    <label>Nombre *</label>
                    <input type="text" id="sucursal-nombre" required placeholder="Sucursal Centro">
                </div>
                <div class="form-group">
                    <label>Direcci√≥n</label>
                    <input type="text" id="sucursal-direccion" placeholder="Av. Principal 123">
                </div>
                <div class="form-group">
                    <label>Estado</label>
                    <select id="sucursal-estado">
                        <option value="activo">Activo</option>
                        <option value="inactivo">Inactivo</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Guardar</button>
            </form>
        </div>
    </div>

    <div id="modalPantalla" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Configurar Pantalla</h2>
                <span class="close-btn" onclick="closeModal('modalPantalla')">&times;</span>
            </div>
            <form onsubmit="savePantalla(event)">
                <input type="hidden" id="pantalla-id">
                <div class="form-group">
                    <label>Nombre de la Pantalla *</label>
                    <input type="text" id="pantalla-nombre" required placeholder="Pantalla Principal Centro">
                </div>
                <div class="form-group">
                    <label>Sucursal *</label>
                    <select id="pantalla-sucursal" required></select>
                </div>
                <div class="form-group">
                    <label>N√∫mero de Pantalla</label>
                    <input type="number" id="pantalla-numero" value="1" min="1">
                </div>
                <div class="form-group">
                    <label>Categor√≠as a mostrar:</label>
                    <div id="pantalla-categorias" class="checkbox-group"></div>
                </div>
                <button type="submit" class="btn btn-primary">Guardar Pantalla</button>
            </form>
        </div>
    </div>

    <div id="modalUsuario" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Usuario</h2>
                <span class="close-btn" onclick="closeModal('modalUsuario')">&times;</span>
            </div>
            <form onsubmit="saveUsuario(event)">
                <input type="hidden" id="usuario-id">
                <div class="form-group">
                    <label>Usuario *</label>
                    <input type="text" id="usuario-username" required>
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="usuario-email" required>
                </div>
                <div class="form-group">
                    <label>Contrase√±a *</label>
                    <input type="password" id="usuario-password" required>
                </div>
                <div class="form-group">
                    <label>Rol *</label>
                    <select id="usuario-rol" required>
                        <option value="admin">Administrador</option>
                        <option value="gerente">Gerente</option>
                        <option value="empleado">Empleado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Estado</label>
                    <select id="usuario-estado">
                        <option value="activo">Activo</option>
                        <option value="inactivo">Inactivo</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Guardar Usuario</button>
            </form>
        </div>
    </div>

    <div id="modalCamposPrecios" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Gestionar Campos de Precios</h2>
                <span class="close-btn" onclick="closeModal('modalCamposPrecios')">&times;</span>
            </div>
            <p style="margin-bottom: 20px; color: #718096;">
                Configura qu√© campos de precios mostrar en tu sistema. Puedes activar/desactivar, editar nombres y agregar nuevos.
            </p>
            
            <button class="btn btn-primary" onclick="agregarCampoPrecio()" style="margin-bottom: 20px;">+ Agregar Campo</button>
            
            <div class="table-container">
                <table id="table-campos-precios">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Detalle</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <button class="btn btn-success" onclick="guardarCamposPrecios()" style="margin-top: 20px;">Guardar Cambios</button>
        </div>
    </div>

    <script>
        // Generate UUID
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Estado global de la aplicaci√≥n
        const appState = {
            categorias: [],
            sabores: [],
            sucursales: [],
            pantallas: [],
            precios: {
                global: {},
                porSucursal: {}
            },
            camposPrecios: [], // NUEVO: Campos de precios configurables
            visibilidad: {},
            usuarios: [],
            sheetsUrl: localStorage.getItem('sheetsUrl') || '',
            config: {
                sheetsUrl: localStorage.getItem('sheetsUrl') || ''
            }
        };

        // Tama√±os de precios POR DEFECTO (ahora editables)
        const DEFAULT_CAMPOS_PRECIOS = [
            { id: '1kg', label: '1 KILO', detalle: '', activo: true },
            { id: 'halfKg', label: '¬Ω KILO', detalle: '', activo: true },
            { id: 'quarterKg', label: '¬º KILO', detalle: '', activo: true },
            { id: 'cucurucho', label: 'CUCURUCHO', detalle: '210g', activo: true },
            { id: 'vaso', label: 'VASO MEDIANO', detalle: '120g', activo: true },
            { id: 'tacitaMed', label: 'TACITA MEDIANA', detalle: '200g', activo: true },
            { id: 'tacitaChica', label: 'TACITA CHICA', detalle: '60g', activo: true },
            { id: 'milkshake', label: 'MILK SHAKE', detalle: '200g', activo: true },
            { id: 'coolshake', label: 'COOL SHAKE', detalle: '200g', activo: true }
        ];

        // ============================================
        // INICIALIZACI√ìN
        // ============================================

        document.addEventListener('DOMContentLoaded', () => {
            loadFromLocalStorage();
            
            // Inicializar campos de precios si no existen
            if (!appState.camposPrecios || appState.camposPrecios.length === 0) {
                appState.camposPrecios = [...DEFAULT_CAMPOS_PRECIOS];
                saveToLocalStorage();
            }
            
            updateAllUI();
            renderPreciosGlobalForm();
        });

        // ============================================
        // NAVEGACI√ìN
        // ============================================

        function showPage(pageName) {
            document.querySelectorAll('.content-card').forEach(card => card.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            
            document.getElementById(`page-${pageName}`).classList.add('active');
            event.target.classList.add('active');

            // Actualizar UI espec√≠fica de la p√°gina
            if (pageName === 'pantallas') renderPantallas();
            if (pageName === 'visibilidad') updateVisibilidadSelects();
            if (pageName === 'precios') updatePreciosSelects();
        }

        function showTabPrecios(tabName) {
            const parent = document.getElementById('page-precios');
            parent.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            parent.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`precios-${tabName}`).classList.add('active');

            if (tabName === 'sucursal') {
                updatePreciosSelects();
            }
        }

        // ============================================
        // MODALES
        // ============================================

        function openModalCategoria(id = null) {
            if (id) {
                const cat = appState.categorias.find(c => c.id === id);
                if (cat) {
                    document.getElementById('categoria-id').value = cat.id;
                    document.getElementById('categoria-nombre').value = cat.nombre;
                    document.getElementById('categoria-descripcion').value = cat.descripcion || '';
                    document.getElementById('categoria-orden').value = cat.orden || 0;
                    document.getElementById('categoria-estado').value = cat.estado;
                }
            }
            openModal('modalCategoria');
        }

        function openModalSabor(id = null) {
            loadCategoriasSelect();
            if (id) {
                const sabor = appState.sabores.find(s => s.id === id);
                if (sabor) {
                    document.getElementById('sabor-id').value = sabor.id;
                    document.getElementById('sabor-nombre').value = sabor.nombre;
                    document.getElementById('sabor-categoria').value = sabor.categoria;
                    document.getElementById('sabor-descripcion').value = sabor.descripcion || '';
                    document.getElementById('sabor-estado').value = sabor.estado;
                }
            }
            openModal('modalSabor');
        }

        function openModalSucursal(id = null) {
            if (id) {
                const suc = appState.sucursales.find(s => s.id === id);
                if (suc) {
                    document.getElementById('sucursal-id').value = suc.id;
                    document.getElementById('sucursal-id-text').value = suc.idText;
                    document.getElementById('sucursal-nombre').value = suc.nombre;
                    document.getElementById('sucursal-direccion').value = suc.direccion || '';
                    document.getElementById('sucursal-estado').value = suc.estado;
                    document.getElementById('sucursal-id-text').readOnly = true;
                } else {
                    document.getElementById('sucursal-id-text').readOnly = false;
                }
            } else {
                document.getElementById('sucursal-id-text').readOnly = false;
            }
            openModal('modalSucursal');
        }

        function openModalPantalla(id = null) {
            loadSucursalesSelect();
            loadCategoriasCheckboxes();
            
            if (id) {
                const pantalla = appState.pantallas.find(p => p.id === id);
                if (pantalla) {
                    document.getElementById('pantalla-id').value = pantalla.id;
                    document.getElementById('pantalla-nombre').value = pantalla.nombre;
                    document.getElementById('pantalla-sucursal').value = pantalla.sucursal;
                    document.getElementById('pantalla-numero').value = pantalla.numero;
                    
                    setTimeout(() => {
                        pantalla.categorias.forEach(catId => {
                            const checkbox = document.getElementById(`cat-${catId}`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }, 100);
                }
            }
            openModal('modalPantalla');
        }

        function openModalUsuario(id = null) {
            if (id) {
                const user = appState.usuarios.find(u => u.id === id);
                if (user) {
                    document.getElementById('usuario-id').value = user.id;
                    document.getElementById('usuario-username').value = user.username;
                    document.getElementById('usuario-email').value = user.email;
                    document.getElementById('usuario-password').value = user.password;
                    document.getElementById('usuario-rol').value = user.rol;
                    document.getElementById('usuario-estado').value = user.estado;
                }
            }
            openModal('modalUsuario');
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            const form = document.querySelector(`#${modalId} form`);
            if (form) form.reset();
        }

        // ============================================
        // ALERTAS
        // ============================================

        function showAlert(type, message) {
            const alertId = type === 'success' ? 'alert-success' : 'alert-error';
            const alert = document.getElementById(alertId);
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => alert.style.display = 'none', 5000);
        }

        // ============================================
        // ALMACENAMIENTO LOCAL
        // ============================================

        function saveToLocalStorage() {
            localStorage.setItem('appState', JSON.stringify(appState));
        }

        function loadFromLocalStorage() {
            const stored = localStorage.getItem('appState');
            if (stored) {
                const data = JSON.parse(stored);
                Object.assign(appState, data);
            }
        }

        // ============================================
        // DASHBOARD
        // ============================================

        function updateDashboard() {
            document.getElementById('stat-categorias').textContent = appState.categorias.length;
            document.getElementById('stat-sabores').textContent = appState.sabores.length;
            document.getElementById('stat-sucursales').textContent = appState.sucursales.length;
            document.getElementById('stat-pantallas').textContent = appState.pantallas.length;
        }

        function updateAllUI() {
            updateDashboard();
            renderCategoriasTable();
            renderSaboresTable();
            renderSucursalesTable();
            renderPantallas();
            renderUsuariosTable();
            updateFilterSelects();
        }

        // ============================================
        // CRUD CATEGOR√çAS
        // ============================================

        function saveCategoria(e) {
            e.preventDefault();
            const id = document.getElementById('categoria-id').value || generateUUID();
            
            const categoria = {
                id,
                nombre: document.getElementById('categoria-nombre').value,
                descripcion: document.getElementById('categoria-descripcion').value,
                orden: parseInt(document.getElementById('categoria-orden').value) || 0,
                estado: document.getElementById('categoria-estado').value
            };

            const index = appState.categorias.findIndex(c => c.id === id);
            if (index >= 0) {
                appState.categorias[index] = categoria;
            } else {
                appState.categorias.push(categoria);
            }

            saveToLocalStorage();
            syncToSheets();
            renderCategoriasTable();
            updateFilterSelects();
            closeModal('modalCategoria');
            showAlert('success', 'Categor√≠a guardada correctamente');
            updateDashboard();
        }

        function deleteCategoria(id) {
            if (!confirm('¬øEliminar esta categor√≠a? Los sabores asociados NO se eliminar√°n.')) return;
            
            appState.categorias = appState.categorias.filter(c => c.id !== id);
            saveToLocalStorage();
            syncToSheets();
            renderCategoriasTable();
            updateFilterSelects();
            showAlert('success', 'Categor√≠a eliminada');
            updateDashboard();
        }

        function renderCategoriasTable() {
            const tbody = document.querySelector('#table-categorias tbody');
            if (!tbody) return;
            tbody.innerHTML = '';

            const sorted = [...appState.categorias].sort((a, b) => a.orden - b.orden);

            sorted.forEach(cat => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${cat.nombre}</strong></td>
                    <td>${cat.descripcion || '-'}</td>
                    <td>${cat.orden}</td>
                    <td><span class="badge badge-${cat.estado === 'activo' ? 'success' : 'danger'}">${cat.estado}</span></td>
                    <td class="action-buttons">
                        <button class="btn btn-primary btn-small" onclick="openModalCategoria('${cat.id}')">Editar</button>
                        <button class="btn btn-danger btn-small" onclick="deleteCategoria('${cat.id}')">Eliminar</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ============================================
        // CRUD SABORES
        // ============================================

        function saveSabor(e) {
            e.preventDefault();
            const id = document.getElementById('sabor-id').value || generateUUID();
            
            const sabor = {
                id,
                nombre: document.getElementById('sabor-nombre').value,
                categoria: document.getElementById('sabor-categoria').value,
                descripcion: document.getElementById('sabor-descripcion').value,
                estado: document.getElementById('sabor-estado').value
            };

            const index = appState.sabores.findIndex(s => s.id === id);
            if (index >= 0) {
                appState.sabores[index] = sabor;
            } else {
                appState.sabores.push(sabor);
            }

            saveToLocalStorage();
            syncToSheets();
            renderSaboresTable();
            closeModal('modalSabor');
            showAlert('success', 'Sabor guardado correctamente');
            updateDashboard();
        }

        function deleteSabor(id) {
            if (!confirm('¬øEliminar este sabor del sistema?')) return;
            
            appState.sabores = appState.sabores.filter(s => s.id !== id);
            
            // Limpiar visibilidad
            Object.keys(appState.visibilidad).forEach(sucursalId => {
                delete appState.visibilidad[sucursalId][id];
            });
            
            saveToLocalStorage();
            syncToSheets();
            renderSaboresTable();
            showAlert('success', 'Sabor eliminado');
            updateDashboard();
        }

        function renderSaboresTable() {
            const tbody = document.querySelector('#table-sabores tbody');
            if (!tbody) return;
            tbody.innerHTML = '';

            const filterCat = document.getElementById('filter-categoria')?.value;
            const filterEstado = document.getElementById('filter-estado')?.value;
            
            let filtered = appState.sabores;
            
            if (filterCat) {
                filtered = filtered.filter(s => s.categoria === filterCat);
            }
            
            if (filterEstado) {
                filtered = filtered.filter(s => s.estado === filterEstado);
            }

            filtered.forEach(sabor => {
                const categoria = appState.categorias.find(c => c.id === sabor.categoria);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${sabor.nombre}</strong></td>
                    <td>${categoria?.nombre || 'Sin categor√≠a'}</td>
                    <td><span class="badge badge-${sabor.estado === 'activo' ? 'success' : 'danger'}">${sabor.estado}</span></td>
                    <td class="action-buttons">
                        <button class="btn btn-primary btn-small" onclick="openModalSabor('${sabor.id}')">Editar</button>
                        <button class="btn btn-danger btn-small" onclick="deleteSabor('${sabor.id}')">Eliminar</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 40px; color: #718096;">No hay sabores para mostrar</td></tr>';
            }
        }

        function filterSabores() {
            renderSaboresTable();
        }

        // ============================================
        // CRUD SUCURSALES
        // ============================================

        function saveSucursal(e) {
            e.preventDefault();
            const isEdit = !!document.getElementById('sucursal-id').value;
            const id = isEdit ? document.getElementById('sucursal-id').value : generateUUID();
            
            const sucursal = {
                id,
                idText: document.getElementById('sucursal-id-text').value.toLowerCase(),
                nombre: document.getElementById('sucursal-nombre').value,
                direccion: document.getElementById('sucursal-direccion').value,
                estado: document.getElementById('sucursal-estado').value
            };

            // Verificar ID √∫nico
            if (!isEdit) {
                const exists = appState.sucursales.find(s => s.idText === sucursal.idText);
                if (exists) {
                    showAlert('error', 'Ya existe una sucursal con ese ID');
                    return;
                }
            }

            const index = appState.sucursales.findIndex(s => s.id === id);
            if (index >= 0) {
                appState.sucursales[index] = sucursal;
            } else {
                appState.sucursales.push(sucursal);
            }

            saveToLocalStorage();
            syncToSheets();
            renderSucursalesTable();
            closeModal('modalSucursal');
            showAlert('success', 'Sucursal guardada');
            updateDashboard();
        }

        function deleteSucursal(id) {
            if (!confirm('¬øEliminar esta sucursal? Se eliminar√°n sus pantallas y configuraciones.')) return;
            
            appState.sucursales = appState.sucursales.filter(s => s.id !== id);
            appState.pantallas = appState.pantallas.filter(p => p.sucursal !== id);
            delete appState.precios.porSucursal[id];
            delete appState.visibilidad[id];
            
            saveToLocalStorage();
            syncToSheets();
            renderSucursalesTable();
            showAlert('success', 'Sucursal eliminada');
            updateDashboard();
        }

        function renderSucursalesTable() {
            const tbody = document.querySelector('#table-sucursales tbody');
            if (!tbody) return;
            tbody.innerHTML = '';

            appState.sucursales.forEach(suc => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><code>${suc.idText}</code></td>
                    <td><strong>${suc.nombre}</strong></td>
                    <td>${suc.direccion || '-'}</td>
                    <td><span class="badge badge-${suc.estado === 'activo' ? 'success' : 'danger'}">${suc.estado}</span></td>
                    <td class="action-buttons">
                        <button class="btn btn-primary btn-small" onclick="openModalSucursal('${suc.id}')">Editar</button>
                        <button class="btn btn-danger btn-small" onclick="deleteSucursal('${suc.id}')">Eliminar</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ============================================
        // CRUD PANTALLAS
        // ============================================

        function savePantalla(e) {
            e.preventDefault();
            const id = document.getElementById('pantalla-id').value || generateUUID();
            
            const checkboxes = document.querySelectorAll('#pantalla-categorias input[type="checkbox"]:checked');
            const categorias = Array.from(checkboxes).map(cb => cb.value);
            
            if (categorias.length === 0) {
                showAlert('error', 'Selecciona al menos una categor√≠a');
                return;
            }
            
            const pantalla = {
                id,
                nombre: document.getElementById('pantalla-nombre').value,
                sucursal: document.getElementById('pantalla-sucursal').value,
                numero: parseInt(document.getElementById('pantalla-numero').value),
                categorias: categorias
            };

            const index = appState.pantallas.findIndex(p => p.id === id);
            if (index >= 0) {
                appState.pantallas[index] = pantalla;
            } else {
                appState.pantallas.push(pantalla);
            }

            saveToLocalStorage();
            syncToSheets();
            renderPantallas();
            closeModal('modalPantalla');
            showAlert('success', 'Pantalla configurada');
            updateDashboard();
        }

        function deletePantalla(id) {
            if (!confirm('¬øEliminar esta pantalla?')) return;
            
            appState.pantallas = appState.pantallas.filter(p => p.id !== id);
            saveToLocalStorage();
            syncToSheets();
            renderPantallas();
            showAlert('success', 'Pantalla eliminada');
            updateDashboard();
        }

        function renderPantallas() {
            const container = document.getElementById('pantallas-list');
            if (!container) return;
            container.innerHTML = '';

            if (appState.pantallas.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì∫</div><p>No hay pantallas configuradas</p></div>';
                return;
            }

            appState.pantallas.forEach(pantalla => {
                const sucursal = appState.sucursales.find(s => s.id === pantalla.sucursal);
                const categoriasNombres = pantalla.categorias
                    .map(catId => appState.categorias.find(c => c.id === catId)?.nombre)
                    .filter(Boolean);

                const baseUrl = window.location.origin + window.location.pathname.replace('index.html', '').replace(/\/$/, '') + '/display.html';
                const url = `${baseUrl}?screen=${pantalla.id}`;

                const div = document.createElement('div');
                div.className = 'screen-config';
                div.innerHTML = `
                    <h4>üì∫ ${pantalla.nombre}</h4>
                    <p><strong>Sucursal:</strong> ${sucursal?.nombre || 'N/A'}</p>
                    <p><strong>N√∫mero:</strong> Pantalla ${pantalla.numero}</p>
                    <p><strong>Categor√≠as:</strong> ${categoriasNombres.join(', ') || 'Ninguna'}</p>
                    <p><strong>URL:</strong></p>
                    <code style="display: block; background: #f7fafc; padding: 10px; border-radius: 4px; margin: 10px 0; word-break: break-all;">${url}</code>
                    <div class="action-buttons" style="margin-top: 10px;">
                        <button class="btn btn-primary btn-small" onclick="openModalPantalla('${pantalla.id}')">Editar</button>
                        <button class="btn btn-danger btn-small" onclick="deletePantalla('${pantalla.id}')">Eliminar</button>
                        <button class="btn btn-success btn-small" onclick="abrirPantalla('${url}')">Abrir</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function abrirPantalla(url) {
            // Asegurar que la URL de sheets est√© guardada en localStorage para que display.html la use
            if (appState.sheetsUrl) {
                localStorage.setItem('sheetsUrl', appState.sheetsUrl);
            }
            window.open(url, '_blank');
        }

        // ============================================
        // PRECIOS
        // ============================================

        function renderPreciosGlobalForm() {
            const container = document.getElementById('form-precios-global');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Bot√≥n para gestionar campos
            const headerDiv = document.createElement('div');
            headerDiv.style.marginBottom = '20px';
            headerDiv.innerHTML = `
                <button type="button" class="btn btn-secondary" onclick="openModalCamposPrecios()">
                    ‚öôÔ∏è Gestionar Campos de Precios
                </button>
            `;
            container.parentElement.insertBefore(headerDiv, container);
            
            const camposActivos = appState.camposPrecios.filter(c => c.activo);
            
            camposActivos.forEach(campo => {
                const value = appState.precios.global[campo.id] || '';
                
                const div = document.createElement('div');
                div.className = 'form-group';
                div.innerHTML = `
                    <label>${campo.label}${campo.detalle ? ` (${campo.detalle})` : ''}</label>
                    <input type="number" id="precio-global-${campo.id}" value="${value}" placeholder="0">
                `;
                container.appendChild(div);
            });
        }

        function savePreciosGlobal(e) {
            e.preventDefault();
            
            const camposActivos = appState.camposPrecios.filter(c => c.activo);
            
            camposActivos.forEach(campo => {
                const value = document.getElementById(`precio-global-${campo.id}`)?.value;
                if (value) {
                    appState.precios.global[campo.id] = parseInt(value);
                }
            });

            saveToLocalStorage();
            syncToSheets();
            showAlert('success', 'Precios globales guardados');
        }

        function updatePreciosSelects() {
            const select = document.getElementById('select-sucursal-precios');
            if (!select) return;
            
            select.innerHTML = '<option value="">Seleccionar...</option>';
            appState.sucursales
                .filter(s => s.estado === 'activo')
                .forEach(suc => {
                    const option = document.createElement('option');
                    option.value = suc.id;
                    option.textContent = suc.nombre;
                    select.appendChild(option);
                });
        }

        function loadPreciosSucursal() {
            const sucursalId = document.getElementById('select-sucursal-precios').value;
            const container = document.getElementById('container-precios-sucursal');
            
            if (!sucursalId) {
                container.innerHTML = '';
                return;
            }

            const sucursal = appState.sucursales.find(s => s.id === sucursalId);
            const preciosSuc = appState.precios.porSucursal[sucursalId] || {};
            
            container.innerHTML = `
                <h3>Precios para ${sucursal.nombre}</h3>
                <p style="color: #718096; margin-bottom: 20px;">Los precios espec√≠ficos sobrescriben los globales. Deja en blanco para usar el precio global.</p>
                <form onsubmit="savePreciosSucursal(event, '${sucursalId}')">
                    <div class="price-form" id="form-precios-sucursal-${sucursalId}"></div>
                    <button type="submit" class="btn btn-primary" style="margin-top: 20px;">Guardar Precios de ${sucursal.nombre}</button>
                </form>
            `;

            const form = document.getElementById(`form-precios-sucursal-${sucursalId}`);
            const camposActivos = appState.camposPrecios.filter(c => c.activo);
            
            camposActivos.forEach(campo => {
                const value = preciosSuc[campo.id] || '';
                const globalValue = appState.precios.global[campo.id] || '';
                
                const div = document.createElement('div');
                div.className = 'form-group';
                div.innerHTML = `
                    <label>${campo.label}${campo.detalle ? ` (${campo.detalle})` : ''}</label>
                    <input type="number" id="precio-suc-${sucursalId}-${campo.id}" value="${value}" placeholder="Global: ${globalValue || 'No configurado'}">
                `;
                form.appendChild(div);
            });
        }

        function savePreciosSucursal(e, sucursalId) {
            e.preventDefault();
            
            if (!appState.precios.porSucursal[sucursalId]) {
                appState.precios.porSucursal[sucursalId] = {};
            }

            const camposActivos = appState.camposPrecios.filter(c => c.activo);
            
            camposActivos.forEach(campo => {
                const value = document.getElementById(`precio-suc-${sucursalId}-${campo.id}`)?.value;
                if (value) {
                    appState.precios.porSucursal[sucursalId][campo.id] = parseInt(value);
                } else {
                    delete appState.precios.porSucursal[sucursalId][campo.id];
                }
            });

            saveToLocalStorage();
            syncToSheets();
            showAlert('success', 'Precios de sucursal guardados');
        }

        // ============================================
        // VISIBILIDAD
        // ============================================

        function updateVisibilidadSelects() {
            const select = document.getElementById('select-sucursal-visibilidad');
            if (!select) return;
            
            select.innerHTML = '<option value="">Seleccionar...</option>';
            appState.sucursales
                .filter(s => s.estado === 'activo')
                .forEach(suc => {
                    const option = document.createElement('option');
                    option.value = suc.id;
                    option.textContent = suc.nombre;
                    select.appendChild(option);
                });
        }

        function loadVisibilidad() {
            const sucursalId = document.getElementById('select-sucursal-visibilidad').value;
            const container = document.getElementById('visibilidad-container');
            
            if (!sucursalId) {
                container.innerHTML = '';
                return;
            }

            const sucursal = appState.sucursales.find(s => s.id === sucursalId);
            
            if (!appState.visibilidad[sucursalId]) {
                appState.visibilidad[sucursalId] = {};
            }

            container.innerHTML = `<h3>Control de disponibilidad en ${sucursal.nombre}</h3>`;

            // Agrupar por categor√≠a
            const categorias = appState.categorias.filter(c => c.estado === 'activo').sort((a, b) => a.orden - b.orden);
            
            categorias.forEach(categoria => {
                const saboresCategoria = appState.sabores.filter(s => s.categoria === categoria.id && s.estado === 'activo');
                
                if (saboresCategoria.length === 0) return;

                const catDiv = document.createElement('div');
                catDiv.className = 'visibility-category';
                catDiv.innerHTML = `<h4>${categoria.nombre}</h4>`;

                saboresCategoria.forEach(sabor => {
                    const disponible = appState.visibilidad[sucursalId][sabor.id]?.disponible !== false;
                    
                    const saborDiv = document.createElement('div');
                    saborDiv.className = 'sabor-toggle';
                    saborDiv.innerHTML = `
                        <span>${sabor.nombre}</span>
                        <label class="toggle-switch">
                            <input type="checkbox" ${disponible ? 'checked' : ''} onchange="toggleVisibilidad('${sucursalId}', '${sabor.id}')">
                            <span class="toggle-slider"></span>
                        </label>
                    `;
                    catDiv.appendChild(saborDiv);
                });

                container.appendChild(catDiv);
            });

            // Bot√≥n para aplicar cambios
            const btnDiv = document.createElement('div');
            btnDiv.style.marginTop = '20px';
            btnDiv.innerHTML = `
                <button class="btn btn-success" onclick="saveAllVisibilidad('${sucursalId}')">
                    Guardar Todos los Cambios
                </button>
                <button class="btn btn-primary" onclick="toggleAllVisibilidad('${sucursalId}', true)" style="margin-left: 10px;">
                    Marcar Todos Disponibles
                </button>
                <button class="btn btn-warning" onclick="toggleAllVisibilidad('${sucursalId}', false)" style="margin-left: 10px;">
                    Marcar Todos No Disponibles
                </button>
            `;
            container.appendChild(btnDiv);
        }

        function toggleVisibilidad(sucursalId, saborId) {
            if (!appState.visibilidad[sucursalId]) {
                appState.visibilidad[sucursalId] = {};
            }

            if (!appState.visibilidad[sucursalId][saborId]) {
                appState.visibilidad[sucursalId][saborId] = {};
            }

            const checkbox = event.target;
            appState.visibilidad[sucursalId][saborId].disponible = checkbox.checked;
            appState.visibilidad[sucursalId][saborId].ultimaActualizacion = new Date().toISOString();
        }

        function saveAllVisibilidad(sucursalId) {
            saveToLocalStorage();
            syncToSheets();
            showAlert('success', 'Visibilidad actualizada');
        }

        function toggleAllVisibilidad(sucursalId, disponible) {
            if (!appState.visibilidad[sucursalId]) {
                appState.visibilidad[sucursalId] = {};
            }

            appState.sabores.forEach(sabor => {
                if (sabor.estado === 'activo') {
                    appState.visibilidad[sucursalId][sabor.id] = {
                        disponible: disponible,
                        ultimaActualizacion: new Date().toISOString()
                    };
                }
            });

            loadVisibilidad();
            saveToLocalStorage();
            syncToSheets();
            showAlert('success', `Todos los sabores marcados como ${disponible ? 'disponibles' : 'no disponibles'}`);
        }

        // ============================================
        // CRUD USUARIOS
        // ============================================

        function saveUsuario(e) {
            e.preventDefault();
            const id = document.getElementById('usuario-id').value || generateUUID();
            
            const usuario = {
                id,
                username: document.getElementById('usuario-username').value,
                email: document.getElementById('usuario-email').value,
                password: document.getElementById('usuario-password').value,
                rol: document.getElementById('usuario-rol').value,
                estado: document.getElementById('usuario-estado').value
            };

            const index = appState.usuarios.findIndex(u => u.id === id);
            if (index >= 0) {
                appState.usuarios[index] = usuario;
            } else {
                appState.usuarios.push(usuario);
            }

            saveToLocalStorage();
            syncToSheets();
            renderUsuariosTable();
            closeModal('modalUsuario');
            showAlert('success', 'Usuario guardado');
        }

        function deleteUsuario(id) {
            if (!confirm('¬øEliminar este usuario?')) return;
            
            appState.usuarios = appState.usuarios.filter(u => u.id !== id);
            saveToLocalStorage();
            syncToSheets();
            renderUsuariosTable();
            showAlert('success', 'Usuario eliminado');
        }

        function renderUsuariosTable() {
            const tbody = document.querySelector('#table-usuarios tbody');
            if (!tbody) return;
            tbody.innerHTML = '';

            appState.usuarios.forEach(user => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${user.username}</strong></td>
                    <td>${user.email}</td>
                    <td>${user.rol}</td>
                    <td><span class="badge badge-${user.estado === 'activo' ? 'success' : 'danger'}">${user.estado}</span></td>
                    <td class="action-buttons">
                        <button class="btn btn-primary btn-small" onclick="openModalUsuario('${user.id}')">Editar</button>
                        <button class="btn btn-danger btn-small" onclick="deleteUsuario('${user.id}')">Eliminar</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ============================================
        // HELPERS
        // ============================================

        function loadCategoriasSelect() {
            const select = document.getElementById('sabor-categoria');
            if (!select) return;
            select.innerHTML = '<option value="">Seleccionar...</option>';
            appState.categorias
                .filter(c => c.estado === 'activo')
                .forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.nombre;
                    select.appendChild(option);
                });
        }

        function loadSucursalesSelect() {
            const select = document.getElementById('pantalla-sucursal');
            if (!select) return;
            select.innerHTML = '<option value="">Seleccionar...</option>';
            appState.sucursales
                .filter(s => s.estado === 'activo')
                .forEach(suc => {
                    const option = document.createElement('option');
                    option.value = suc.id;
                    option.textContent = suc.nombre;
                    select.appendChild(option);
                });
        }

        function loadCategoriasCheckboxes() {
            const container = document.getElementById('pantalla-categorias');
            if (!container) return;
            container.innerHTML = '';
            
            appState.categorias
                .filter(c => c.estado === 'activo')
                .sort((a, b) => a.orden - b.orden)
                .forEach(cat => {
                    const div = document.createElement('div');
                    div.className = 'checkbox-item';
                    div.innerHTML = `
                        <input type="checkbox" id="cat-${cat.id}" value="${cat.id}">
                        <label for="cat-${cat.id}">${cat.nombre}</label>
                    `;
                    container.appendChild(div);
                });
        }

        function updateFilterSelects() {
            const filterCat = document.getElementById('filter-categoria');
            if (filterCat) {
                const currentValue = filterCat.value;
                filterCat.innerHTML = '<option value="">Todas las categor√≠as</option>';
                appState.categorias.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.nombre;
                    filterCat.appendChild(option);
                });
                filterCat.value = currentValue;
            }
        }

        // ============================================
        // SINCRONIZACI√ìN CON GOOGLE SHEETS
        // ============================================

        async function syncData() {
            if (!appState.sheetsUrl) {
                showAlert('error', 'Configura la URL de Google Sheets primero');
                showPage('configuracion');
                return;
            }

            try {
                showAlert('success', 'üîÑ Sincronizando con Google Sheets...');
                
                const response = await fetch(appState.sheetsUrl, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'syncAll',
                        data: appState
                    })
                });

                const result = await response.json();
                if (result.success) {
                    showAlert('success', '‚úÖ Sincronizaci√≥n completada');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                showAlert('error', 'Error al sincronizar: ' + error.message);
            }
        }

        async function syncToSheets() {
            if (appState.sheetsUrl) {
                syncData();
            }
        }

        async function loadFromSheets() {
            if (!appState.sheetsUrl) {
                showAlert('error', 'Configura la URL de Google Sheets primero');
                return;
            }

            try {
                showAlert('success', 'üì• Cargando datos desde Google Sheets...');
                
                const response = await fetch(`${appState.sheetsUrl}?action=getAllData`);
                const result = await response.json();

                if (result.success && result.data) {
                    // Cargar todos los datos
                    Object.assign(appState, result.data);
                    
                    // Si viene la URL de sheets en los datos, actualizarla
                    if (result.data.sheetsUrl) {
                        appState.sheetsUrl = result.data.sheetsUrl;
                        localStorage.setItem('sheetsUrl', result.data.sheetsUrl);
                        document.getElementById('sheets-url').value = result.data.sheetsUrl;
                    }
                    
                    // Si no hay campos de precios, usar los por defecto
                    if (!appState.camposPrecios || appState.camposPrecios.length === 0) {
                        appState.camposPrecios = [...DEFAULT_CAMPOS_PRECIOS];
                    }
                    
                    saveToLocalStorage();
                    updateAllUI();
                    showAlert('success', '‚úÖ Datos cargados correctamente desde Google Sheets');
                } else {
                    throw new Error(result.message || 'Error desconocido');
                }
            } catch (error) {
                showAlert('error', 'Error al cargar datos: ' + error.message);
            }
        }

        // ============================================
        // CONFIGURACI√ìN
        // ============================================

        function saveConfig() {
            const url = document.getElementById('sheets-url').value;
            if (!url) {
                showAlert('error', 'Ingresa una URL v√°lida');
                return;
            }
            appState.sheetsUrl = url;
            localStorage.setItem('sheetsUrl', url);
            saveToLocalStorage();
            showAlert('success', 'Configuraci√≥n guardada');
            updateScreenUrls();
        }

        async function testConnection() {
            const url = document.getElementById('sheets-url').value;
            const statusDiv = document.getElementById('connection-status');
            
            if (!url) {
                showAlert('error', 'Ingresa una URL primero');
                return;
            }

            statusDiv.className = 'connection-status';
            statusDiv.innerHTML = '<p>‚è≥ Probando conexi√≥n con Google Sheets...</p>';

            try {
                const response = await fetch(`${url}?action=test`);
                const data = await response.json();

                if (data.success) {
                    statusDiv.className = 'connection-status success';
                    statusDiv.innerHTML = '<p>‚úÖ Conexi√≥n exitosa con Google Sheets</p>';
                    appState.sheetsUrl = url;
                    
                    // Guardar en localStorage Y en el appState
                    localStorage.setItem('sheetsUrl', url);
                    saveToLocalStorage();
                    
                    // IMPORTANTE: Sincronizar para que la URL quede guardada en Google Sheets
                    await syncData();
                    
                    showAlert('success', 'URL guardada y sincronizada con Google Sheets');
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                statusDiv.className = 'connection-status error';
                statusDiv.innerHTML = `<p>‚ùå Error: ${error.message}</p>`;
            }
        }

        function updateScreenUrls() {
            const container = document.getElementById('screen-urls');
            if (!container) return;

            if (appState.pantallas.length === 0) {
                container.innerHTML = '<p style="color: #718096;">No hay pantallas configuradas todav√≠a</p>';
                return;
            }

            const baseUrl = window.location.origin + window.location.pathname.replace('index.html', 'display.html');
            
            container.innerHTML = appState.pantallas.map(pantalla => {
                const sucursal = appState.sucursales.find(s => s.id === pantalla.sucursal);
                return `
                    <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 5px;">
                        <strong>${pantalla.nombre}</strong> (${sucursal?.nombre})<br>
                        <code style="font-size: 0.85em; word-break: break-all;">${baseUrl}?screen=${pantalla.id}</code>
                    </div>
                `;
            }).join('');
        }

        function logout() {
            if (confirm('¬øCerrar sesi√≥n?')) {
                window.location.reload();
            }
        }

        // ============================================
        // GESTI√ìN DE CAMPOS DE PRECIOS
        // ============================================

        function openModalCamposPrecios() {
            renderCamposPreciosTable();
            openModal('modalCamposPrecios');
        }

        function renderCamposPreciosTable() {
            const tbody = document.querySelector('#table-campos-precios tbody');
            if (!tbody) return;
            tbody.innerHTML = '';

            appState.camposPrecios.forEach((campo, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <input type="text" value="${campo.label}" 
                               onchange="appState.camposPrecios[${index}].label = this.value"
                               style="width: 100%; padding: 5px;">
                    </td>
                    <td>
                        <input type="text" value="${campo.detalle || ''}" 
                               onchange="appState.camposPrecios[${index}].detalle = this.value"
                               placeholder="Ej: 200g"
                               style="width: 100%; padding: 5px;">
                    </td>
                    <td>
                        <label class="toggle-switch">
                            <input type="checkbox" ${campo.activo ? 'checked' : ''} 
                                   onchange="appState.camposPrecios[${index}].activo = this.checked">
                            <span class="toggle-slider"></span>
                        </label>
                    </td>
                    <td class="action-buttons">
                        <button class="btn btn-danger btn-small" onclick="eliminarCampoPrecio(${index})">Eliminar</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function agregarCampoPrecio() {
            const nuevoCampo = {
                id: 'campo_' + Date.now(),
                label: 'Nuevo Campo',
                detalle: '',
                activo: true
            };
            appState.camposPrecios.push(nuevoCampo);
            renderCamposPreciosTable();
        }

        function eliminarCampoPrecio(index) {
            if (!confirm('¬øEliminar este campo de precio?')) return;
            appState.camposPrecios.splice(index, 1);
            renderCamposPreciosTable();
        }

        function guardarCamposPrecios() {
            saveToLocalStorage();
            syncToSheets();
            renderPreciosGlobalForm();
            closeModal('modalCamposPrecios');
            showAlert('success', 'Campos de precios actualizados');
        }

        // ============================================
        // CARGAR CONFIGURACI√ìN AL INICIO
        // ============================================

        window.addEventListener('load', () => {
            const url = localStorage.getItem('sheetsUrl');
            if (url) {
                document.getElementById('sheets-url').value = url;
            }
            updateScreenUrls();
        });
    </script>
</body>
</html>
