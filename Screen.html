<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pantalla - Helader√≠a</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #f5f5f5;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }

        /* PANTALLA DE PRECIOS */
        .screen-prices {
            display: none;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 60px;
        }

        .screen-prices.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .prices-title {
            font-size: 5em;
            font-weight: bold;
            color: white;
            margin-bottom: 60px;
            text-align: center;
        }

        .prices-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 40px;
            max-width: 90%;
        }

        .price-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s;
        }

        .price-card:hover {
            transform: translateY(-10px);
        }

        .price-icon {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            font-size: 4em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .price-name {
            font-size: 2em;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .price-detail {
            font-size: 1.2em;
            color: #718096;
            margin-bottom: 20px;
        }

        .price-value {
            font-size: 3.5em;
            font-weight: bold;
            color: #667eea;
        }

        /* PANTALLA DE SABORES */
        .screen-flavors {
            display: none;
            width: 100%;
            height: 100%;
            background: white;
            padding: 60px;
        }

        .screen-flavors.active {
            display: block;
        }

        .flavors-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .flavors-title {
            font-size: 4em;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .categories-container {
            display: grid;
            gap: 50px;
        }

        /* Auto-detect mejor layout seg√∫n cantidad de categor√≠as */
        .categories-container.cols-1 { grid-template-columns: 1fr; }
        .categories-container.cols-2 { grid-template-columns: 1fr 1fr; }
        .categories-container.cols-3 { grid-template-columns: repeat(3, 1fr); }

        .category-section {
            background: #f8f9fa;
            border-radius: 20px;
            padding: 30px;
        }

        .category-title {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }

        .flavors-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .flavor-item {
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 1.3em;
            color: #2d3748;
            font-weight: 500;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .flavor-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }

        .flavor-item.unavailable {
            opacity: 0.4;
            text-decoration: line-through;
        }

        .flavor-dot {
            width: 12px;
            height: 12px;
            background: #667eea;
            border-radius: 50%;
            flex-shrink: 0;
        }

        /* LOADING */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            font-size: 1.5em;
            color: white;
        }

        /* ERROR */
        .error-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #2c2c2c;
            color: white;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .error-icon {
            font-size: 5em;
            margin-bottom: 20px;
        }

        .error-title {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .error-message {
            font-size: 1.2em;
            color: #a0aec0;
        }

        .last-update {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8em;
        }

        /* Responsive para pantallas verticales */
        @media (orientation: portrait) {
            .prices-grid {
                grid-template-columns: 1fr;
            }

            .categories-container.cols-2,
            .categories-container.cols-3 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">Cargando pantalla...</div>
    </div>

    <!-- Error Screen -->
    <div class="error-screen" id="error-screen">
        <div class="error-icon">‚ö†Ô∏è</div>
        <div class="error-title">Error al cargar</div>
        <div class="error-message" id="error-message">Verifica la configuraci√≥n</div>
    </div>

    <!-- Pantalla de Precios -->
    <div class="screen-prices" id="screen-prices">
        <div class="prices-title">PRECIOS</div>
        <div class="prices-grid" id="prices-grid"></div>
    </div>

    <!-- Pantalla de Sabores -->
    <div class="screen-flavors" id="screen-flavors">
        <div class="flavors-header">
            <div class="flavors-title" id="screen-title">SABORES</div>
        </div>
        <div class="categories-container" id="categories-container"></div>
    </div>

    <div class="last-update" id="last-update">√öltima actualizaci√≥n: --:--</div>

    <script>
        let SHEETS_URL = '';
        let currentScreenId = '';
        let screenConfig = null;
        let screenData = null;
        let autoRefreshInterval = null;
        const REFRESH_INTERVAL = 30000; // 30 segundos
        const CACHE_KEY = 'screenData';

        // √çconos para los precios (puedes personalizarlos)
        const PRICE_ICONS = {
            '1kg': 'üç®',
            'halfKg': 'ü•Ñ',
            'quarterKg': 'üç¶',
            'cucurucho': 'üç¶',
            'vaso': 'ü•§',
            'tacitaMed': 'ü•Ñ',
            'tacitaChica': 'ü•Ñ',
            'milkshake': 'ü•§',
            'coolshake': 'ü•§',
            'bombon': 'üç¨',
            'bochita': 'üç¶',
            'tacita': 'ü•Ñ',
            'baldes': 'ü™£',
            'almendrado': 'üç®',
            'frambiccis': 'üçì'
        };

        function getScreenId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('screen');
        }

        document.addEventListener('DOMContentLoaded', () => {
            currentScreenId = getScreenId();
            
            if (!currentScreenId) {
                showError('URL inv√°lida', 'Esta URL necesita un par√°metro ?screen=ID');
                return;
            }

            SHEETS_URL = localStorage.getItem('sheetsUrl');
            
            loadFromCache();
            loadScreenData();
            startAutoRefresh();
        });

        async function loadScreenData() {
            try {
                if (!SHEETS_URL) {
                    console.log('No hay URL configurada, usando cach√©');
                    return;
                }
                
                const response = await fetch(`${SHEETS_URL}?action=getScreenData&screenId=${currentScreenId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    screenData = result.data;
                    saveToCache(screenData);
                    displayScreen(screenData);
                    hideLoading();
                    updateLastUpdateTime();
                } else {
                    throw new Error(result.message || 'Error al obtener datos');
                }
                
            } catch (error) {
                console.error('Error cargando datos:', error);
                const cached = loadFromCache();
                if (cached) {
                    hideLoading();
                } else {
                    showError('Error de conexi√≥n', 'No se pudo conectar y no hay datos en cach√©');
                }
            }
        }

        function saveToCache(data) {
            try {
                localStorage.setItem(CACHE_KEY + '_' + currentScreenId, JSON.stringify(data));
                localStorage.setItem(CACHE_KEY + '_timestamp_' + currentScreenId, Date.now().toString());
            } catch (e) {
                console.error('Error guardando cach√©:', e);
            }
        }

        function loadFromCache() {
            try {
                const cached = localStorage.getItem(CACHE_KEY + '_' + currentScreenId);
                if (cached) {
                    screenData = JSON.parse(cached);
                    displayScreen(screenData);
                    return true;
                }
            } catch (e) {
                console.error('Error cargando cach√©:', e);
            }
            return false;
        }

        function displayScreen(data) {
            console.log('Mostrando pantalla:', data);
            
            if (data.tipo === 'precios') {
                displayPricesScreen(data);
            } else if (data.tipo === 'sabores') {
                displayFlavorsScreen(data);
            }
        }

        function displayPricesScreen(data) {
            const pricesScreen = document.getElementById('screen-prices');
            const flavorsScreen = document.getElementById('screen-flavors');
            
            pricesScreen.classList.add('active');
            flavorsScreen.classList.remove('active');
            
            const grid = document.getElementById('prices-grid');
            grid.innerHTML = '';
            
            if (!data.precios || Object.keys(data.precios).length === 0) {
                grid.innerHTML = '<p style="color: white; font-size: 2em;">No hay precios configurados</p>';
                return;
            }

            Object.entries(data.precios).forEach(([key, value]) => {
                const labelMap = {
                    '1kg': { label: '1 KILO', detalle: '' },
                    'halfKg': { label: '¬Ω KILO', detalle: '' },
                    'quarterKg': { label: '¬º KILO', detalle: '' },
                    'cucurucho': { label: 'CUCURUCHO', detalle: '' },
                    'vaso': { label: 'VASO MEDIANO', detalle: '120g' },
                    'tacitaMed': { label: 'TACITA MEDIANA', detalle: '200g' },
                    'tacitaChica': { label: 'TACITA CHICA', detalle: '60g' },
                    'milkshake': { label: 'MILKSHAKE', detalle: '200g' },
                    'coolshake': { label: 'COOLSHAKE', detalle: '200g' },
                    'bombon': { label: 'BOMB√ìN', detalle: '6u' },
                    'bochita': { label: 'BOCHITA', detalle: '' },
                    'tacita': { label: 'TACITA/VASITO', detalle: '' },
                    'baldes': { label: 'BALDES', detalle: '3 LTS' },
                    'almendrado': { label: 'ALMENDRADO', detalle: 'BARRA 15' },
                    'frambiccis': { label: 'FRAMBICCIS', detalle: 'POR 5u' }
                };

                const info = labelMap[key] || { label: key.toUpperCase(), detalle: '' };
                const icon = PRICE_ICONS[key] || 'üç®';

                const card = document.createElement('div');
                card.className = 'price-card';
                card.innerHTML = `
                    <div class="price-icon">${icon}</div>
                    <div class="price-name">${info.label}</div>
                    ${info.detalle ? `<div class="price-detail">${info.detalle}</div>` : ''}
                    <div class="price-value">$ ${value.toLocaleString('es-AR')}</div>
                `;
                grid.appendChild(card);
            });
        }

        function displayFlavorsScreen(data) {
            const pricesScreen = document.getElementById('screen-prices');
            const flavorsScreen = document.getElementById('screen-flavors');
            
            pricesScreen.classList.remove('active');
            flavorsScreen.classList.add('active');
            
            const title = document.getElementById('screen-title');
            title.textContent = data.pantalla?.nombre || 'SABORES';
            
            const container = document.getElementById('categories-container');
            container.innerHTML = '';
            
            if (!data.categorias || Object.keys(data.categorias).length === 0) {
                container.innerHTML = '<p style="text-align: center; font-size: 2em; color: #718096;">No hay sabores configurados</p>';
                return;
            }

            // Determinar n√∫mero de columnas seg√∫n cantidad de categor√≠as
            const numCats = Object.keys(data.categorias).length;
            container.className = 'categories-container';
            if (numCats === 1) container.classList.add('cols-1');
            else if (numCats === 2) container.classList.add('cols-2');
            else container.classList.add('cols-3');

            Object.values(data.categorias).forEach(categoria => {
                if (!categoria.sabores || categoria.sabores.length === 0) return;

                const section = document.createElement('div');
                section.className = 'category-section';
                
                const title = document.createElement('div');
                title.className = 'category-title';
                title.textContent = categoria.nombre;
                section.appendChild(title);

                const list = document.createElement('div');
                list.className = 'flavors-list';

                categoria.sabores.forEach(sabor => {
                    const item = document.createElement('div');
                    item.className = `flavor-item ${sabor.disponible === false ? 'unavailable' : ''}`;
                    item.innerHTML = `
                        <div class="flavor-dot"></div>
                        <span>${sabor.nombre}</span>
                    `;
                    list.appendChild(item);
                });

                section.appendChild(list);
                container.appendChild(section);
            });
        }

        function startAutoRefresh() {
            autoRefreshInterval = setInterval(() => {
                console.log('Auto-refresh: Actualizando...');
                loadScreenData();
            }, REFRESH_INTERVAL);
        }

        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('last-update').textContent = `√öltima actualizaci√≥n: ${timeString}`;
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showError(title, message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-screen').style.display = 'flex';
            document.getElementById('error-message').textContent = message;
        }

        window.addEventListener('beforeunload', () => {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        });
    </script>
</body>
</html>
